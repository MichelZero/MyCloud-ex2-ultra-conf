<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia Definitivo: Entware Persistente - WD My Cloud</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="navbar">
        <div class="container">
            <div class="logo">
                <span class="wd-blue">WD</span> My Cloud <span class="model-name">EX2 Ultra</span>
            </div>
            <div class="version">Tutorial Shell v2.0 - OS 5</div>
        </div>
    </header>

    <main class="container">
        <section class="intro">
            <h1>Entware com Persistência Total</h1>
            <p>Este guia atualizado utiliza o método de <strong>App Hijacking</strong> para garantir que o Entware e o PATH do sistema sobrevivam a reinicializações no OS 5.</p>
        </section>

        <article class="step-card">
            <div class="step-number">01</div>
            <div class="step-content">
                <h3>Instalação Base</h3>
                <p>Execute os comandos para preparar o diretório e instalar o Entware no HD principal.</p>
                <div class="code-block">
                    <code>mkdir -p /mnt/HD/HD_a2/entware</code>
                    <code>rm -rf /opt && ln -sf /mnt/HD/HD_a2/entware /opt</code>
                    <code>wget -O - http://bin.entware.net/armv7sf-k3.2/installer/generic.sh | sh</code>
                </div>
            </div>
        </article>

        <article class="step-card">
            <div class="step-number">02</div>
            <div class="step-content">
                <h3>Instalação de Ferramentas</h3>
                <p>Agora que o <code>opkg</code> está ativo, instale o htop e o nano.</p>
                <div class="code-block">
                    <code>/opt/bin/opkg update</code>
                    <code>/opt/bin/opkg install htop nano</code>
                </div>
            </div>
        </article>

        <article class="step-card highlight">
            <div class="step-number">03</div>
            <div class="step-content">
                <h3>Persistência Automática (O Segredo)</h3>
                <p>Edite o script de inicialização de um App oficial (ex: Transmission) para restaurar o Entware no boot.</p>
                <p>Arquivo: <code>/mnt/HD/HD_a2/Nas_Prog/Transmission/init.sh</code></p>
                <div class="code-block">
                    <code># Adicione estas linhas logo após o #!/bin/sh</code>
                    <code>rm -rf /opt</code>
                    <code>ln -sf /mnt/HD/HD_a2/entware /opt</code>
                    <code>ln -sf /usr/local/modules/perl5 /opt/perl5</code>
                    <code>ln -sf /usr/local/modules/opt/wd /opt/wd</code>
                </div>
            </div>
        </article>

        <article class="step-card highlight-blue">
            <div class="step-number">04</div>
            <div class="step-content">
                <h3>Persistência do Comando (PATH)</h3>
                <p>Para que o comando <code>htop</code> funcione direto sem digitar o caminho completo após o reboot, injete o PATH no perfil do sistema.</p>
                <div class="code-block">
                    <code># Adicione isto também no init.sh do Transmission</code>
                    <code>if ! grep -q "opt/bin" /etc/profile; then</code>
                    <code>&nbsp;&nbsp;echo "export PATH=\$PATH:/opt/bin:/opt/sbin" >> /etc/profile</code>
                    <code>fi</code>
                </div>
            </div>
        </article>

        <article class="step-card highlight">
            <div class="step-number">05</div>
            <div class="step-content">
                <h3>Script completo do init.sh do Transmission</h3>
                <p>Para que o comando <code>htop</code> funcione direto sem digitar o caminho completo após o reboot, injete o PATH no perfil do sistema.</p>
                <div class="code-block">
                    <pre>
                    #!/bin/sh

                    #
                    # SPDX-FileCopyrightText: 2020 Western Digital Corporation or its affiliates.
                    #
                    # SPDX-License-Identifier: GPL-2.0-or-later
                    #

                    <div class="code-block highlight">
                        # 1. Destroi a pasta temporária do boot e cria o link REAL
                        rm -rf /opt
                        ln -sf /mnt/HD/HD_a2/entware /opt

                        # 2. Restaura os itens vitais da Western Digital
                        ln -sf /usr/local/modules/perl5 /opt/perl5
                        ln -sf /usr/local/modules/opt/wd /opt/wd

                        # 3. Injeta o PATH (para o htop funcionar de primeira)
                        if ! grep -q "opt/bin" /etc/profile; then
                            echo "export PATH=$PATH:/opt/bin:/opt/sbin" >> /etc/profile
                        fi

                        # 4. Inicia os serviços (O que o antigo init_entware.sh fazia)
                        [ -x /opt/etc/init.d/rc.unslung ] && /opt/etc/init.d/rc.unslung start
                    </div>

                    [ -f /tmp/debug_apkg ] && echo "APKG_DEBUG: $0 $@" >> /tmp/debug_apkg

                    path=$1

                    echo "Link file from : $path"

                    # link library
                    ln -sf $path/lib/libminiupnpc.so.17 /lib/
                    ln -sf $path/lib/libnatpmp.so.1 /lib/

                    # link program, cgi
                    ln -sf $path/bin/transmission-daemon /usr/bin/
                    ln -sf $path/bin/transmission-remote /usr/bin/

                    # create a folder for webpage
                    WEBPATH="/var/www/Transmission/"
                    mkdir -p $WEBPATH

                    # webpage, function, css, js, cgi
                    ln -sf $path/web/* $WEBPATH

                    WEBPATH_CONFIG="/var/www/apps/Transmission/"
                    mkdir -p $WEBPATH_CONFIG

                    # webpage, function, css, js, cgi for config
                    ln -sf $path/web_config/* $WEBPATH_CONFIG
                    </pre>

                </div>
            </div>
        </article>

        <section class="usage">
            <h2>Verificação de Sucesso</h2>
            <p>Após reiniciar o NAS, o comando abaixo deve funcionar instantaneamente em qualquer nova sessão SSH:</p>
            <div class="terminal-box">
                <code>opkg update</code><br>
                <code>opkg install htop</code><br>
                <code>htop</code>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            Documentação Técnica - Uso de HD 24TB & Otimização Shell.
        </div>
    </footer>
</body>
</html>